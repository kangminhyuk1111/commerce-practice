# 9. 주문(Order)

## 주문 기능 정의
- 주문: 사용자가 원하는 상품을 구매하는 정보로, 선택된 상품을 선택하고, 결제, 배송으로 이어지도록 하는 도메인

## 주문 도메인 규칙
- 주문하기 위해서는 최소 1개이상의 상품이 포함되어야 한다.
- 주문 시점에 상품 재고를 확인해야 한다.
- 주문 가격은 상품가격 x 수량으로 계산한다.
- 주문 생성시 결제 방법을 선택해야 한다.
- 배송 주소를 입력 받도록 한다.

## 주문 상태
- 주문은 총 5가지 상태로 정의한다.
- **PENDING**: 주문 대기
- **PAYMENT_SUCCESS**: 결제 성공
- **PAYMENT_FAILED**: 결제 실패
- **PAYMENT_CANCELLED**: 사용자가 결제를 취소한 경우 -> 주문이 삭제됨
- **SHIPPING_WAITING**: 배송 대기
- **SHIPPED**: 배송 중
- **SHIPPING_FINISH**: 배송 완료
- 결제가 완료되지 않으면 배송으로 넘어가지 않는다.
- 배송 대기 상태 까지만 주문 취소가 가능하다.

#### 상태 전이 규칙
- 정상 흐름: PENDING → PAYMENT_SUCCESS → SHIPPING_WAITING → SHIPPED → SHIPPING_COMPLETED
- 결제 실패 시: PENDING → PAYMENT_FAILED (재결제 가능)
- 결제 취소 시: PENDING 또는 SHIPPING_WAITING → PAYMENT_CANCELLED
- 결제가 완료되지 않으면 배송 상태로 진행할 수 없다.
- SHIPPING_WAITING 상태까지만 주문 취소가 가능하다.
- SHIPPED 이후 상태에서는 주문 취소 불가능하다.

## 할인 적용
- 주문 창에서 적용 가능한 쿠폰을 조회하고 적용시킨다.
- 쿠폰이 적용되면 상품은 할인된 가격으로 총액에 더해진다.

## 결제 규칙
- 주문 이후 결제는 30분안에 일어나야 한다.
- 30분안에 일어나지 않으면 주문은 자동으로 미결제로 취소된다.

## 주문의 생성 타이밍
- 주문의 생성 타이밍은 사용자의 입력을 모두 받고 유효성 검사를 통과한 이후
- 주문 페이지 이동 -> 결제 타입 선택 -> 포인트 사용 선택 -> 배송지 입력
- 이후 주문 버튼을 클릭시 주문이 생성되고 바로 결제를 할 수 있도록 한다.

## 유스케이스 시나리오
### ORDER-UC-001-01: 상품 상세에서 단품 주문 생성 성공
1. 사용자가 상품 상세 페이지로 접근한다.
2. 상품 상세 페이지에서 바로 구매 버튼을 클릭한다.
3. 시스템이 해당 상품의 재고를 확인한다.
4. 주문 페이지로 이동하며, 선택된 상품 정보(상품명, 가격, 수량)를 표시한다.
5. 사용자가 적용 가능한 쿠폰을 조회하고 원하는 쿠폰을 선택하여 적용한다.
6. 시스템이 쿠폰 할인을 계산하여 최종 가격을 표시한다.
7. 사용자가 결제 타입을 선택한다. (신용카드, 계좌이체, 휴대폰 결제 등)
8. 사용자가 포인트 사용 여부를 선택한다. (선택사항)
9. 사용자가 기존 배송지를 사용하거나, 배송지를 새로 입력한다.
10. 최종 확인후 주문 완료 버튼을 클릭한다.
11. 주문이 PENDING 상태로 생성된다.

### ORDER-UC-001-02: 상품 상세에서 단품 주문 생성 실패 - 상품 재고 부족
1. 사용자가 상품 상세 페이지로 접근한다.
2. 상품 상세 페이지에서 바로 구매 버튼을 클릭한다.
3. 시스템이 해당 상품의 재고를 확인한다.
4. 상품의 재고가 부족하다면 "해당 상품의 재고가 부족합니다." 예외 발생
5. 예외 발생 이후에 상품 목록 화면으로 돌아간다.

### ORDER-UC-001-03: 상품 상세에서 단품 주문 생성 실패 - 판매 불가 상품
1. 사용자가 상품 상세 페이지로 접근한다.
2. 상품 상세 페이지에서 바로 구매 버튼을 클릭한다.
3. 시스템이 상품의 판매 가능 상태를 확인한다.
4. 해당 상품이 판매 불가 상태인 경우 "현재 판매 불가능한 상품입니다." 예외 발생
5. 사용자에게 오류 메시지를 표시하고 상품 목록 화면으로 돌아간다.

### ORDER-UC-002-01: 장바구니에서 다중 상품 주문 생성 성공
1. 사용자가 장바구니 페이지로 접근한다.
2. 장바구니에 상품이 담겨있다.
3. 사용자가 주문할 상품을 선택한다. (체크박스)
4. 사용자가 "상품 주문" 버튼을 클릭한다.
5. 시스템이 선택된 상품들의 재고를 확인한다.
6. 주문 페이지로 이동하며, 선택된 상품 정보(상품명, 가격, 수량)를 목록으로 표시한다.
7. 사용자가 적용 가능한 쿠폰을 조회하고 상품별로 원하는 쿠폰을 선택하여 적용한다.
8. 시스템이 쿠폰 할인을 계산하여 최종 가격을 표시한다.
9. 사용자가 결제 타입을 선택한다. (신용카드, 계좌이체, 휴대폰 결제 등)
10. 사용자가 포인트 사용 여부를 선택한다. (선택사항)
11. 사용자가 기존 배송지를 사용하거나, 배송지를 새로 입력한다.
12. 최종 확인 후 주문 완료 버튼을 클릭한다.
13. 주문이 PENDING 상태로 생성된다.
14. 선택된 상품들이 장바구니에서 제거된다.

### ORDER-UC-002-02: 장바구니에서 다중 상품 주문 생성 실패 - 상품 재고 부족
1. 사용자가 장바구니 페이지로 접근한다.
2. 장바구니에 상품이 담겨있다.
3. 사용자가 주문할 상품을 선택한다.
4. 사용자가 상품 주문 버튼을 클릭한다.
5. 서버에서 상품이 판매 가능 상태인지 검증한다.
6. 재고가 부족한 상태이므로 "상품의 재고가 부족합니다." 예외 처리한다.
7. 재고가 부족한 상품은 장바구니에서 삭제된다.