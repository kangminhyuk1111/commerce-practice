# 5. 찜하기

## 개요
- 기능명: 포인트
- 목적: 사용자가 포인트를 적립하고 포인트를 사용할 수 있는 기능

## 강의 내용 정리
- 포인트 - 결제시에 포인트사용 및 적립
- 포인트 만료 정책, 유효기간이 존재하나요?
- 포인트 한도가 존재하나요?
- 포인트 사용의 최소 단위가 존재하는지?
- 결제 취소 시에 사용된 포인트는 어떻게 복구되는지?
- UI로만 풀 수 없는 상황이면 정책 요구사항을 정의해달라고 부탁한다.

## 요구사항 분석
- 포인트는 적립식으로 유저당 하나의 포인트 계좌를 가지고 포인트가 적립된다.
- 포인트는 적립, 소모 시에 History 테이블에 이력을 남긴다.
- 포인트는 만료기간이 존재하지 않으며 적립되면 사용되기 전 까지 유지된다.
- 포인트사용은 한도가 존재하지 않는다.
- 포인트의 최소 사용 단위는 1000원이다.
- 결제 도메인이 미구현 상태이므로 결제 취소는 추후 과제로 남긴다.

### 고민 사항 정리
#### 포인트는 데이터 정합성이 중요하다고 판단
  - 동시성 문제에 대한 고민
  - 동시에 포인트가 차감되는 일이 생길 수 있을까? 동시에 차감된다면 어떤식으로 동시 차감을 막아야 할까?
  - 현재 생각으로는 동시에 포인트가 차감되는 일이 빈번하지는 않지만, 재화와 연결되는 부분이기 때문에 동시 차감을 강하게 막아야 한다고 생각한다.
  - Race Condition(경합 상태)에 대해서 고민해볼 필요가 있어 보인다.
#### History는 어떻게 남기는게 효율적일까? Point History의 구성요소에 대해서 고민. 모든 History 테이블이 같은 데이터를 갖나?
  - History는 BaseEntity와 다르게 가져가는 것으로 판단했다.
  - 왜냐하면, History같은 경우 updatedAt이 불필요하다고 생각했고 추가적으로 필요한 컬럼(ipAddress, deviceInfo)처럼 History만이 갖는 컬럼이 따로 존재한다고 판단했다.
#### 포인트의 최소 사용 단위가 변경될 수 있다면 어떻게 관리하는게 좋을까?
  - 이전에 했던 것 처럼 정책 관리 객체를 만든다. Policy Validator
#### 추후 결제가 취소되는 상황에서 포인트 반환은 어떻게 할 것 인가?

### 테이블 구성
#### Point(포인트) extends BaseEntity
- Id: Long
- userId: Long, 포인트 계좌 보유자의 고유 식별자
- balance: BigDecimal, 현재 포인트 계좌의 잔액

#### PointHistory(포인트 적립, 사용 내역) extends HistoryEntity
- Id: Long
- userId: Long, 포인트 계좌 보유자의 고유 식별자
- pointAmount: BigDecimal, 사용, 충전된 금액
- pointTransactionType: Enum(in, out) 사용인지 충전인지 구분하는 구분자
- balanceAfter: BigDecimal, 계산이후 남은 금액, 포인트 추가 이후 총 금액
