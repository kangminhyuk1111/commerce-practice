# 7. 쿠폰

## 요구사항 분석

### 쿠폰
- 이커머스에서의 쿠폰은 지정된 상품을 구매하기 전 단계에서 사용자가 선택하고 가격을 할인받을 수 있도록 하는 정책중 하나
- 정책이기 때문에 쿠폰의 구현 방법과 적용 방법은 정하기 나름이라고 생각
- 쿠폰의 궁극적인 목적은 사용자를 유입시키기 위함. 악성재고 처리도 포함.

## 쿠폰 사용 플로우

#### 1. 쿠폰 발급 방식
- 쿠폰은 사용자가 상품 상세를 들어갔을 때 연관된 쿠폰을 받을 수 있도록 한다.
- 쿠폰은 총 3가지 정도를 가지도록 한다.
  - 전체 적용 가능 쿠폰, 단일 상품에 적용 가능한 쿠폰, 전체에 적용 가능한 쿠폰
- 사용자가 상품과 대응하는 쿠폰 리스트를 조회하고 리스트에서 쿠폰 받기를 클릭해서 쿠폰을 저장한다.

#### 2. 쿠폰 발급
- 발급된 쿠폰은 사용자의 userId와 대응하도록 별도의 테이블에서 관리된다. (owned_coupons 테이블)
- 쿠폰의 유효기간은 쿠폰마다 다르게 설정하는게 맞지만, 기본적으로는 발급시간 기준 30일로 정의한다.
- 추후 발급시간이 유동적으로 변경되어야 하는 경우를 고려해야한다.
- 발급 시점에 만료일시를 계산하여 저장한다 (발급시간 + 유효기간).
- 동일한 쿠폰은 한번 밖에 발급받지 못하도록 제한한다. exist로 확인

#### 3. 만료 처리 정책
- 만료되면 사용 불가능 상태로 백엔드에서 변경한다.
- 총 2가지의 사용 불가능 상태 변경이 있다.
- 제일 중요한 것은 만료된 것을 사용하려 할 때 사용하지 못하도록 막아준다.
- 두번째는, 사용자가 사용하지 않아도 자동으로 상태를 변경해주어야 한다. 배치 처리를 통해 일정한 시간에 모든 쿠폰을 확인하여 만료상태를 변경해준다.

#### 4. 쿠폰 할인 금액
- 현재는 고정된 할인 값으로 정의한다.
- 추후 확장에서 비율 할인을 추가한다.

#### 5. 쿠폰 적용 범위
- 의류 카테고리에 사용 가능한 1,000원 할인 쿠폰
- A상품에만 적용 가능한 2,000원 쿠폰
- 총 2가지의 적용 가능 범위가 존재한다. 카테고리 별로 적용, 특정 상품에만 적용

#### 6. 적용 가능한 쿠폰 조회
- 쿠폰 조회시 상품에 적용 가능한 쿠폰을 조회한다. (상품, 카테고리에 적용되는 쿠폰을 조회해서 List로 반환.)
- A상품(의류 카테고리): 의류 카테고리 적용 가능한 쿠폰 + A 상품에 적용 가능한 쿠폰 조회

#### 7. 중복 적용 여부
- 쿠폰은 상품당 하나의 쿠폰만 적용이 가능함

#### 8. 동일한 쿠폰 재발급 여부
- 동일한 쿠폰은 사용후 재발급이 되면 안됨.
- 같은 쿠폰을 여러번 받는 것도 불가능
 
## 유저 플로우 정의
1. 사용자가 상품 상세 페이지에서 적용 가능한 쿠폰을 조회한다.
2. 조회한 쿠폰들을 다운로드 받으면 쿠폰이 사용자의 ID를 기준으로 테이블에 저장된다. (owned_coupon)
3. 장바구니에 담고 추후 결제를 할 때, 가지고있는 적용 가능한 쿠폰을 조회하고 사용자 맞춤으로 사용할 수 있다.

#### API 목록
- 적용 가능한 쿠폰 조회
- 쿠폰 다운로드
- 가지고 있는 쿠폰 조회

#### 추가 구현 사항
1. 현재는 쿠폰 적용단계가 아니기 때문에 3가지 API로 충족
2. 장바구니 및 주문이 구현되면 추후 개발한다. 주문 시 쿠폰 적용

## 쿠폰 테이블 정의

### 쿠폰
- ID
- name: 쿠폰 이름
- couponType: 쿠폰 타입(비율 할인, 고정 값 할인)
- discount: 할인 가격 및 비율
- expiredAt: 만료 시간
- applyTargetType: 적용 가능한 대상 타입
- applyTargetValue: 적용 대상 값

### 소유 쿠폰
- ID
- userId: 소유자 ID
- state: 쿠폰의 상태(Download, Used)
- coupon: 보유한 쿠폰의 정보